%-  LaTeX source file

%-  performance.tex ~~
%
%   This is the fourth section of the paper.
%
%                                                   ~~ last updated 27 Nov 2018

%Availability note: code supporting this section is available at
%\url{https://github.com/ATLAS-Titan/moab-data}. 

%\subsection{Scaling PanDA on Titan}
%\label{subsec:scaling}

%See Figure ~\ref{fig:throughput-all} \ldots
%% For two-column wide figures use
%\begin{figure*}
%% Use the relevant command to insert your figure file.
%% For example, with the graphicx package use
%  \includegraphics[width=0.75\textwidth]{images/linfit-throughput-all.png}
%% figure caption is below the figure
%\caption{This figure shows the relationship between CSC108 backfill throughput
%and overall throughput by counting jobs completed by day.}
%\label{fig:throughput-all}
%\end{figure*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The PanDA team, known primarily by the project identifier ``CSC108'' at Oak
Ridge, began work on this project in 2013, and our opportunistic consumption of
backfill resources on Titan has increased steadily every year. During this time
period, overall utilization on Titan has increased as well, which is consistent
with our expectations because CSC108 seeks to consume time-sensitive resources
that would otherwise go to waste. The simple bar plot shown in
Figure~\ref{fig:jacks-slide} was created to visualize this progress over time,
and interestingly, it also shows that utilization by other projects has been
decreasing over the same time period. A first reaction when observing this
pattern might be to blame CSC108 for crowding out other projects on Titan, but
careful consideration reveals that there are many other mechanisms which might
be behind these effects. Consequently, we undertook several studies in order to
assess the impact CSC108 is having on Titan and its users, especially with
respect to wait times, throughput, and utilization. This section presents
results from several ongoing studies.

% For two-column wide figures use
\begin{figure*}
% Use the relevant command to insert your figure file.
% For example, with the graphicx package use
  \includegraphics[width=0.75\textwidth]{images/barplot-jacks-slide.png}
% figure caption is below the figure
\caption{This bar plot visualizes the yearly utilization of Titan core hours,
separated into two categories: utilization of Titan core hours through backfill
opportunities by CSC108, and all other utilization of core hours on Titan. The
data for 2018 are incomplete; they cover from January 1, 2018 to September 1,
2018.}
\label{fig:jacks-slide}
\end{figure*}


Before presenting results, however, it is important to summarize the relevant
policies at Oak Ridge for running jobs on Titan. There are three queues on
Titan: batch, debug, and killable. There is no actual backfill queue on Titan;
instead, smaller jobs from each queue are scheduled into spaces that cannot be
used by larger jobs. The batch queue is the default queue for submitted jobs,
and it is the only queue considered in this analysis. Jobs submitted to the
batch queue are grouped into five ``bins'' according to the number of requested
nodes, and each bin has a maximum wall time. Jobs that request fewer nodes have
correspondingly lesser maximum wall times. The definitions and rules for each
bin are shown in Table~\ref{tab:olcfbins}. Nodes are assigned exclusively to
one job at a time. Because Titan is a leadership class machine and priority is
a function of wait time, the batch scheduler awards aging boosts to jobs in
bins 1 and 2 in order to prioritize larger jobs over smaller ones. Once jobs in
the batch queue begin to run, however, they will not be killed when new jobs
arrive, regardless of their priority. Sometimes, jobs small enough to use
currently idle resources on Titan are scheduled to run immediately, and this is
what we refer to as ``backfill opportunity''. CSC108 takes advantage of the
``showbf'' command in order to query the Moab scheduler directly for currently
available backfill opportunity and then tailors its own submissions to Titan
accordingly. CSC108 has a special policy applied to guarantee that its jobs run
with lesser priority than all others on Titan, to ensure that its jobs consume
only backfill resources. Finally, ``Titan core hours'' are the billable units
used at OLCF; they convert at a rate of 30 Titan core hours per 1 node hour.

% For tables use
\begin{table}
% table caption is above the table
\caption{OLCF policies sort jobs into numbered bins based on the requested
number of nodes, and each bin has its own set of constraints.}
\label{tab:olcfbins}       % Give a unique label
% For LaTeX tables use
\begin{tabular}{crrr}
\hline\noalign{\smallskip}
Bin & Requested Nodes   & Maximum Wall Time &   Aging Boost \\
\noalign{\smallskip}\hline\noalign{\smallskip}
1   &   11,250 - 18,688 &   24 hours        &   15 days     \\
2   &    3,750 - 11,249 &   24 hours        &    5 days     \\
3   &       313 - 3,749 &   12 hours        &         0     \\
4   &         126 - 312 &    6 hours        &         0     \\
5   &           1 - 125 &    2 hours        &         0     \\
\noalign{\smallskip}\hline
\end{tabular}
\end{table}


% For two-column wide figures use
\begin{figure*}
% Use the relevant command to insert your figure file.
% For example, with the graphicx package use
  \includegraphics[width=0.75\textwidth]{images/time-vs-nodes-backfill.png}
% figure caption is below the figure
\caption{This figure shows that the PanDA deployment on Titan runs CSC108 jobs
that vary in size by time and by space. The stair steps occur due to the
constraints from Titan policy by bin. The jobs in the bottom left ``column''
run in bin 5, the jobs in the middle are running in bin 4, and the jobs on the
right are bin 3. Note that the rightmost boundary of the plot, at 350 nodes,
represents a self-imposed constraint.}
\label{fig:time-vs-nodes}
\end{figure*}

The studies have collected datasets in several different ways. Initially, we
began by sampling live data from Moab by polling with Python scripts launched
by cron jobs on a data transfer node. These scripts recorded XML output from
the ``showbf'' and ``showq'' commands into files, and more cron jobs launched
other Python scripts to import these files' sample data into SQLite. These
tables contain data about the exact state of the queues at given times,
including active jobs, blocked jobs, eligible jobs, recently completed jobs,
and system information such as active nodes and available backfill
opportunities. We then supplemented these live samples with monthly usage data
and historical job traces obtained from ORNL. The monthly usage data span from
January 2016 to September 2018 and contain only the total hours available,
total hours consumed by all projects, and total hours consumed by CSC108. The
job trace data span from January 2017 to October 2018 and contain only job
submission time, start time, completion time, requested nodes, and requested
wall time, for all jobs not due to the PanDA team. Besides CSC108, the PanDA
team has two other PanDA projects on Titan, which are HEP110 and HEP113, both
of which use PanDA to submit jobs with the increased priority of their ALCC
allocations. Thus, traces for the PanDA jobs contain additional fields for
account name, job name, and user name to distinguish the backfill jobs from the
``direct mode'' jobs. Finally, we analyzed the SQLite data in Python using the
well-known Matplotlib, NumPy, and SciPy libraries via Anaconda.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Wait Times}
\label{subsec:waittimes}

First, we discuss the impact of CSC108's jobs on the wait times experienced by
other projects' jobs on Titan.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Blocking Model}
\label{subsubsec:blockingmodel}

We began by developing a simple model to estimate how often that a CSC108 job
was using resources on Titan that would have been used by another project's job
if they had been available. To this end, we defined an abstract event called a
``block'' and then detected occurrences of the event within our data.

Let $C_i$ be the abstract resources in use by CSC108 at the $i^{\text{th}}$
sample point in time, and let $U_i$ be the unused (idle) resources remaining on
Titan. We then define a boolean $B_i$ representing a ``block'' to be 1 if there
exists at least one job at the $i^{\text{th}}$ sample point which requests
$(C_i + U_i)$ resources or less when $C_i$ is non-zero; we define $B_i$ to be
zero otherwise. Summing $B_i$ over all $i$ gives a count of sample points at
which a block occurred, and dividing that count by the number of total sample
points yields a quantity we call a ``blocking fraction''. The blocking fraction
is a rational number between 0 and 1, with lesser numbers corresponding to
lesser impacts by CSC108.

To apply this abstract model to a real data set, we have initially defined the
resources in a purely ``spatial'' manner by considering only jobs' requested
numbers of nodes. Further work will explore ``temporal'' blocking by also
considering jobs' requested wall times.

\textbf{(Specific numbers and graphs go here.)}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Dormant period}
\label{subsubsec:dormantperiod}

An interesting opportunity arose during July 2018 following the end of a large
simulation campaign by ATLAS, because CSC108 submitted zero backfill jobs for
14 consecutive days. For convenience, we have called this the ``dormant
period''.

\textbf{Keep going.}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Throughput}
\label{subsec:throughput}


Next, we discuss the impact of CSC108's jobs on throughput on Titan.
\begin{itemize}
    \item Explain linear regression results and how a pattern appears for bin 5
\end{itemize}


% For two-column wide figures use
\begin{figure*}
% Use the relevant command to insert your figure file.
% For example, with the graphicx package use
  \includegraphics[width=0.75\textwidth]{images/linfit-throughput-all.png}
% figure caption is below the figure
\caption{(placeholder)}
\label{fig:throughput-all}
\end{figure*}

% For two-column wide figures use
\begin{figure*}
% Use the relevant command to insert your figure file.
% For example, with the graphicx package use
  \includegraphics[width=0.75\textwidth]{images/linfit-throughput-bin3.png}
% figure caption is below the figure
\caption{(placeholder)}
\label{fig:throughput-bin3}
\end{figure*}

% For two-column wide figures use
\begin{figure*}
% Use the relevant command to insert your figure file.
% For example, with the graphicx package use
  \includegraphics[width=0.75\textwidth]{images/linfit-throughput-bin4.png}
% figure caption is below the figure
\caption{(placeholder)}
\label{fig:throughput-bin4}
\end{figure*}

% For two-column wide figures use
\begin{figure*}
% Use the relevant command to insert your figure file.
% For example, with the graphicx package use
  \includegraphics[width=0.75\textwidth]{images/linfit-throughput-bin5.png}
% figure caption is below the figure
\caption{(placeholder)}
\label{fig:throughput-bin5}
\end{figure*}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Utilization}
\label{subsec:utilization}

Finally, we are investigating the effects of CSC108's utilization of backfill
opportunity on the overall utilization of Titan by all projects. To do this, we
constructed using linear models again, in a manner very similar to that of
Section~\ref{subsec:throughput}.


% For two-column wide figures use
\begin{figure*}
% Use the relevant command to insert your figure file.
% For example, with the graphicx package use
  \includegraphics[width=0.75\textwidth]{images/linfit-utilization-by-true-day-all.png}
% figure caption is below the figure
\caption{(placeholder)}
\label{fig:utilization-all}
\end{figure*}


% For two-column wide figures use
\begin{figure*}
% Use the relevant command to insert your figure file.
% For example, with the graphicx package use
  \includegraphics[width=0.75\textwidth]{images/linfit-utilization-by-true-day-bin3.png}
% figure caption is below the figure
\caption{(placeholder)}
\label{fig:utilization-bin3}
\end{figure*}


% For two-column wide figures use
\begin{figure*}
% Use the relevant command to insert your figure file.
% For example, with the graphicx package use
  \includegraphics[width=0.75\textwidth]{images/linfit-utilization-by-true-day-bin4.png}
% figure caption is below the figure
\caption{(placeholder)}
\label{fig:utilization-bin4}
\end{figure*}


% For two-column wide figures use
\begin{figure*}
% Use the relevant command to insert your figure file.
% For example, with the graphicx package use
  \includegraphics[width=0.75\textwidth]{images/linfit-utilization-by-true-day-bin5.png}
% figure caption is below the figure
\caption{(placeholder)}
\label{fig:utilization-bin5}
\end{figure*}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Conclusions}
\label{subsec:sec4-conclusions}

In conclusion,
\begin{itemize}
    \item We probably need to restrict ourselves to being ``sand'' and not
        ``pebbles''
    \item Further results are needed to confirm these trends, and studies are
        ongoing.
\end{itemize}


%-  vim:set syntax=tex:
